<!DOCTYPE html>
<html lang="ko">

<head>

  <!-- Webpage Title -->
  <title>Hello, world!</title>

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bulma CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
  <!-- JS -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

        table {
            border-collapse: collapse;
            width: 100%;
            text-align: center;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            min-width: 100px;
        }

        th {
            background-color: #f2f2f2;
        }

        h1 {
            margin-bottom: 30px;
        }

        .container {
            width: 80%;
        }

        .add-habit {
            margin-bottom: 20px;
        }

        .habit-menu {
            display: flex;
            justify-content: space-between;
        }
        .nodate {
            color: gray;
            background-color: rgba(0, 0, 0, 0.05);
            font-size: 10pt;
        }
    </style>
</head>

<body>
    <div class="container">
        
        <header class="habit-header">
            <h1>Mini Habit Tracker</h1>
			<h5 class="subtitle">ë‚˜ì˜ ë‹‰ë„¤ì„ì€: {{nickname}}</h5>
      		<button class="button is-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒí•˜ê¸°</button>
        </header>
        <nav class="habit-menu">
            <div class="add-habit">
          <input type="text" id="habitInput" onkeyup="enterkey('addHabit')" placeholder="ìƒˆë¡œìš´ ìŠµê´€ ì¶”ê°€">
                <button id="addHabit" onclick="addHabit()">ì¶”ê°€</button>
            </div>
            <div class="change-date">
                <label for="datepicker">ì¡°íšŒí•˜ê³  ì‹¶ì€ ê³¼ê±° ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</label>
                <input type="week" name="datepicker" id="date-picked">
                <button class="datepicker-confirm" onclick="getChangedDate()">í™•ì¸</button>
            </div>
        </nav>
        <main class="table-habit">
        <table>
            <thead>
                <tr class="header">
                    <th class="header__info">habit</th>

                    <th class="habit-progress">ì§„ë„ìœ¨</th>
                </tr>
            </thead>
            <tbody id="habitList">
                <!-- ì¶”ê°€ ìŠµê´€ í–‰ì´ ì´ ìœ„ì¹˜ì— ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤. -->
                <tr>
                    <td>ì œëª©1
                        <button id="updateHabit">ìˆ˜ì •</button>
                        <button id="deleteHabit">ì‚­ì œ</button>
                    </td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td> 30 % </td>
                </tr>
                <tr>
                    <td>ì œëª©2
                        <button id="updateHabit">ìˆ˜ì •</button>
                        <button id="deleteHabit">ì‚­ì œ</button>
                    </td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td> 100%</td>
                </tr>
            </tbody>
        </table>
    </main>
    <script>
        // ë¡œê·¸ì•„ì›ƒì€ ë‚´ê°€ ê°€ì§€ê³  ìˆëŠ” í† í°ë§Œ ì¿ í‚¤ì—ì„œ ì—†ì• ë©´ ë©ë‹ˆë‹¤.
        function logout() {
            $.removeCookie('mytoken');
            alert('ë¡œê·¸ì•„ì›ƒ!')
            window.location.href = '/login'
        }

        document.addEventListener("DOMContentLoaded", function(){
            const todayStr = new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString().split("T")[0];
            getAndSetDate();
            showHabit(`{{nickname}}`, todayStr);
            // datepicker ì˜¤ëŠ˜ ì´í›„ì˜ ë‚ ì§œ ì„ íƒí•˜ì§€ ëª»í•˜ê²Œ ì œí•œ ê±¸ê¸°
            setLimitWeek("#date-picked");
        });

        function enterkey(event_name) {
            if (window.event.keyCode == 13) {
                // ì—”í„°í‚¤ê°€ ëˆŒë ¸ì„ ë•Œ
                if(event_name == 'addHabit')
                addHabit()
            }
        }

    
        function setLimitWeek (selectQuery) { // ì˜¤ëŠ˜ ì´í›„ì˜ ë‚ ì§œë¥¼ ì„ íƒí•˜ì§€ ëª»í•˜ë„ë¡ ì œí•œ ê±°ëŠ” í•¨ìˆ˜, selectQueryëŠ” week inputì˜ selectQuery (string)
            const todayStr = new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString().split("T")[0];
            const today = new Date(todayStr);
            const thisYear = today.getFullYear()
            const thisYearBeginStr = thisYear + "-01-01"
            const firstDay = new Date(thisYearBeginStr);
            const weeksFromStart = Math.ceil((Math.abs((today.getTime() - firstDay.getTime()) / (1000 * 60 * 60 * 24)) / 7))
            const yearWeekStr = thisYear + "-W" + weeksFromStart

            console.log(document.querySelector(selectQuery))
            document.querySelector(selectQuery).setAttribute("max", yearWeekStr);
        }

        function getWeekDateByWeekNum (yearNum, weekNum) { // ì—°ë„-ì£¼ ë‹¨ìœ„ë¥¼ ë°›ì•„ í•´ë‹¹ ì—°ë„ì˜ ì£¼ì°¨ ì‹œì‘ì´ ì–´ë–¤ ë‚ ì§œì¸ì§€ ë°›ì•„ì˜¤ëŠ” í•¨ìˆ˜ (return dateStr)
            const weekStartsAt = new Date(yearNum, 0, 1 + (weekNum - 1) * 7);
            const dayOfWeek = weekStartsAt.getDay();
            let isoWeekStart = weekStartsAt;
            if (dayOfWeek <= 4) {
                isoWeekStart.setDate(weekStartsAt.getDate() - dayOfWeek + 1);
            } else {
                isoWeekStart.setDate(weekStartsAt.getDate() + 8 - dayOfWeek);
            }
            const startDateString = new Date(isoWeekStart - new Date().getTimezoneOffset() * 60000).toISOString().split("T")[0];
            return startDateString;
        }

        function showHabit(User_ID, dateStr){
            let formData = new FormData();
            console.log(`dateStr: ${dateStr}`)
            formData.append("dateStr_give", dateStr)
            formData.append("User_ID_give", User_ID);
            fetch('/showHabit', { method: "POST", body: formData, }).then((res) => res.json()).then((data) => {
                let habitHTML = ``
                document.querySelector("#habitList").innerHTML = ""
                data["result"].forEach(v => {
                    console.log(v)
                    habitHTML += `
                                <tr>
                                    <td>${v["habit"]}
                                    <button id="updateHabit" onclick = "updateHabit('${v['_id']}')">ìˆ˜ì •</button>
                                    <button id="deleteHabit" onclick = "deleteHabit('${v['_id']}')">ì‚­ì œ</button>
                                    </td>                    
                    `
                    let count = 0
                    let total = 0
                    const weeklyComplete = v["complete"]
                    for (j = 0; j < weeklyComplete.length; j++) {
                        const dailyComplete = weeklyComplete[j]
                        if (typeof(dailyComplete)==="boolean") {
                            if (dailyComplete) {
                                const addHTML = `
                                                <td><input onclick = "habitcomp('${v['_id']}')" id = "my_checkbox_${j}_${v['_id']}" type="checkbox" checked></td>
                                `
                                habitHTML += addHTML
                                count++
                                total++
                            } else {
                                const addHTML = `
                                                <td><input onclick = "habitcomp('${v['_id']}')" id = "my_checkbox_${j}_${v['_id']}" type="checkbox"></td>
                                `
                                habitHTML += addHTML
                                total++
                            }
                        } else { // ë§Œì•½ ë“¤ì–´ê°„ ê°’ì´ stringì´ë©´
                            if (dailyComplete === "none") {
                                const addHTML = `
                                                <td class="nodate">habit ì„¤ì • ì´ì „ ğŸ«¢</td>
                                `
                                habitHTML += addHTML
                            }
                        }
                    }
                    if (count != 0 && total != 0) {
                        const lastHTML = `
                                        <td class="habit-progress"> ${Number.parseFloat(count / total * 100).toFixed(0)}% </td>
                                    </tr>`
                        habitHTML += lastHTML
                    } else {
                        const lastHTML = `
                                        <td class="habit-progress"> o% </td>
                                    </tr>`
                        habitHTML += lastHTML
                    }

                })
                document.querySelector("#habitList").innerHTML = habitHTML;   
            })
            //     rows = data["result"]
            //     console.log(rows)
            //     let temp_html = ``
            //     $('#habitList').empty();
            //     rows.forEach(element => {
            //         temp_html = `
            //                     <tr>
            //                     <td>${element['habit']}
            //                     <button id="updateHabit" onclick = "updateHabit('${element['_id']}')">ìˆ˜ì •</button>
            //                     <button id="deleteHabit" onclick = "deleteHabit('${element['_id']}')">ì‚­ì œ</button>
            //                     </td>
            //                     <td><input type="checkbox"></td>
            //                     <td><input type="checkbox"></td>
            //                     <td><input type="checkbox"></td>
            //                     <td><input type="checkbox"></td>
            //                     <td><input type="checkbox"></td>
            //                     <td><input type="checkbox"></td>
            //                     <td><input type="checkbox"></td>
            //                     <td> 30 % </td>
            //                     </tr>
            //     `

            //         //console.log(temp_html)
            //         $("#habitList").append(temp_html); //$('#board_list').append(temp_html)
            //     });
            //     // $("#board_list").append(temp_html);
            // });
        }

        function addHabit() {
            let formData = new FormData();

            let TODO = habitInput.value;
        let User_ID = `{{nickname}}`;
            let complete = 'complete';
            let displayDate = 'display';
        if (TODO == '') {
            alert("ìŠµê´€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!!")
            return;
        }

            formData.append("TODO_give", TODO);
            formData.append("User_ID_give", User_ID);
            formData.append("complete_give", complete);
            formData.append("displayDate_give", displayDate);


        fetch('/Habit', { method: "POST", body: formData, }).then((res) => res.json()).then((data) => {
            rows = data["result"]
            if (rows == 'add') {
            window.location.reload();
            }
            else {
            alert(rows)
            }


        });



        }

        function deleteHabit(_id) {
            if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ ?") == true) {
                fetch('/Habit/' + _id, { method: "DELETE" }).then((res) => res.json()).then((data) => {

                });

                window.location.reload()
            }


        }

        function updateHabit(_id) {

            let habit_update = prompt("ìˆ˜ì •í•  ìŠµê´€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”")

        if (habit_update == null || habit_update == "") {
            alert("ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šìœ¼ì…¨ë„¤ìš” ìˆ˜ì •ì„ ì•ˆí•©ë‹ˆë‹¤")
        } else {
            console.log(_id, habit_update)
            // let User_ID = 'test_id';
            let User_ID = `{{nickname}}`;
            console.log(User_ID,habit_update)
            let data = {
            'TODO_give': habit_update,
            'User_ID_give': User_ID
            };
            console.log(data)
            fetch("/Habit/" + _id, { method: "PUT", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then((res) => res.json()).then((data) => {
            rows = data["result"]
            console.log(rows)
            if (rows == 'update') {
                window.location.reload();
            }
            else {
                alert(rows)
            }

            });

        }



        }

        function getAndSetDate() {
            fetch("/dateShow").then(response => response.json()).then(data => {
                const dates = data.result;
                habitSetDate(dates)
            });
        }

        // function getAndSetDate() {
        //     fetch("/dateShow").then(response => response.json()).then(data => {
        //         console.log(data)
        //         const dates = data.result;
        //         console.log(dates)
        //         dates.slice().reverse().forEach(v => {
        //             console.log(v)
        //             const dayArray = ["ì¼ìš”ì¼", "ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼"]
        //             const day = dayArray[new Date(v).getDay()]
        //             console.log(day)
        //             const addHtml = `
        //                             <th><span class="date">${v}</span><br><span class="day">${day}</span></th>
        //             `
        //             document.querySelector(".header__info").insertAdjacentHTML("afterend", addHtml);
        //         });
        //     })
        // }

        function habitSetDate(dateStrArray) {
            let headerHTML = ``
            dateStrArray.slice().reverse().forEach(v => {
                const dayArray = ["ì¼ìš”ì¼", "ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼"]
                const day = dayArray[new Date(v).getDay()]
                const addHTML = `
                                <th><span class="date">${v}</span><br><span class="day">${day}</span></th>
                `
                headerHTML = addHTML + headerHTML
            });

            document.querySelector(".header").innerHTML = ""
            headerHTML = `
                                    <th class="header__info">habit</th>
            ` + headerHTML //ë‚ ì§œê°€ ë’¤ë°”ë€Œì–´ì„œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤


            const lastHTML = `
                                            <th class="header__progress">ì§„ë„ìœ¨</th>
                                        </tr>
                        `
            headerHTML += lastHTML
            document.querySelector(".header").innerHTML = headerHTML;
        }


        function getChangedDate() { // datepicker ì¡°íšŒ ëŒ€ìƒ ì£¼ì˜ ì²«ë²ˆì§¸ ë‚ ì§œ ìŠ¤íŠ¸ë§ êµ¬í•˜ì—¬ ë°±ì—”ë“œë¡œ ë„˜ê²¨ì£¼ê³  ë°±ì—”ë“œì—ì„œ ì œì‘í•œ ë°ì´í„° ê¾¸ëŸ¬ë¯¸ í’€ì–´ì„œ HTMLì— ì¨ì¤Œ
            const userId = `{{nickname}}`;
            const pickerDate = document.querySelector("#date-picked").value;
            if (pickerDate.length !== 0) { // pickerDateì— ì•„ë¬´ ë‚ ì§œë„ ì„ íƒí•˜ì§€ ì•Šê³  'í™•ì¸' ë²„íŠ¼ë§Œ ëˆ„ë¥¸ ê²ƒì€ ì œì™¸

                const yearWeek = pickerDate.split("-W");
                const weekStartDate = getWeekDateByWeekNum(Number(yearWeek[0]), Number(yearWeek[1]));
                const queryString = `/habitDateChange?userid="${userId}"&weekStartDate="${weekStartDate}"`

                fetch(queryString).then(res => res.json()).then((data) => {
                    const dataArray = data["result"]
                    let repackData = []
                    for (i = dataArray.length; i > 0; i--) {
                        repackData.push(dataArray[i - 1])
                    }

                    const displayDate = repackData[0]["displayDate"]


                    habitSetDate(displayDate); // ë°”ë€ ë‚ ì§œ ì…ë ¥í•´ì£¼ê¸°
                    
                    document.querySelector("#habitList").innerHTML = ""
                    let habitHTML = ``
                    repackData.forEach(v => {
                        console.log(v)
                        habitHTML += `
                                    <tr>
                                        <td>${v["habit"]}
                                        <button id="updateHabit" onclick = "updateHabit('${v['_id']}')">ìˆ˜ì •</button>
                                        <button id="deleteHabit" onclick = "deleteHabit('${v['_id']}')">ì‚­ì œ</button>
                                        </td>                    
                        `
                        const weeklyComplete = v["complete"]
                        let count = 0
                        let total = 0
                        for (j = 0; j < weeklyComplete.length; j++) {
                            const dailyComplete = weeklyComplete[j]
                            if (typeof(dailyComplete)==="boolean") {
                                if (dailyComplete) {
                                    const addHTML = `
                                                    <td><input onclick = "habitcomp('${v['_id']}')" id = "my_checkbox_${j}_${v['_id']}" type="checkbox" checked></td>
                                    `
                                    habitHTML += addHTML
                                    count++
                                    total++
                                } else {
                                    const addHTML = `
                                                    <td><input onclick = "habitcomp('${v['_id']}')" id = "my_checkbox_${j}_${v['_id']}" type="checkbox"></td>
                                    `
                                    habitHTML += addHTML
                                    total++
                                }
                            } else { // ë§Œì•½ ë“¤ì–´ê°„ ê°’ì´ stringì´ë©´
                                if (dailyComplete === 'none') {
                                    const addHTML = `
                                                    <td class="nodate">habit ì„¤ì • ì´ì „ ğŸ«¢</td>
                                    `
                                    habitHTML += addHTML
                                }
                            }
                        }
                        //ì§„í–‰ë¥ 
                        if (count != 0 && total != 0) {
                            const lastHTML = `
                                        <td class="habit-progress"> ${Number.parseFloat(count / total * 100).toFixed(0)}% </td>
                                    </tr>`
                            habitHTML += lastHTML
                        } else {
                            const lastHTML = `
                                        <td class="habit-progress"> o% </td>
                                    </tr>`
                            habitHTML += lastHTML
                        }

                    })
                    document.querySelector("#habitList").innerHTML = habitHTML;   
                })
            } else {
                return
            }
        }

        function habitcomp(_id) {
            let checklist = []
            for (i = 0; i < 7; i++) {
                let idname = 'my_checkbox_' + i + '_' + _id
                console.log(idname)

                if (document.getElementById(idname) === null) {
                    checklist.push('none')
                } else {
                    let checkbox = document.getElementById(idname);
                    console.log(checkbox)
                    let is_checked = checkbox.checked;
                    checklist.push(is_checked)
                }
            }
            console.log(_id, checklist) ///ì—¬ê¸°ê¹Œì§„ ì˜ ë‚˜ì˜¨ë‹¤!

            let formData = new FormData();
            formData.append('habit_update_give', checklist);
            fetch('/HabitComp/' + _id, { method: "POST", body: formData }).then((res) => res.json()).then((data) => {
                    
            });
        window.location.reload()
        }
    </script>
</body>

</html>